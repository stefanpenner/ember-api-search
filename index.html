<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ember Starter Kit</title>
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <script type="text/x-handlebars">
    <h2>Welcome to Ember.js</h2>

    {{outlet}}
  </script>

  <script type="text/x-handlebars" data-template-name="index">
    {{view Ember.TextField valueBinding=query}}
    <ul>
      {{#each item in model.classes}}
        <li>{{item.name}}</li>
      {{/each}}
      {{#each item in model.files}}
        <li>{{item.name}}</li>
      {{/each}}
      {{#each item in model.modules}}
        <li>{{item.name}}</li>
      {{/each}}
      {{#each item in model.classItems}}
        <li>{{item.name}}{{item.file}}:{{item.line}}{{item.type}}</li>
      {{/each}}
    </ul>
    </ul>
  </script>

  <script src="js/libs/jquery-1.9.1.js"></script>
  <script src="js/libs/handlebars-1.0.0-rc.3.js"></script>
  <script src="js/libs/ember-1.0.0-rc.2.js"></script>
  <script src="js/app.js"></script>

  <script>
    $.getJSON('api.json').then(preprocess);

    function preprocess(data){
      window.json = data;
      window.classes = Object.keys(json.classes);
      window.files = Object.keys(json.files);
      window.modules = Object.keys(json.modules);
    }

    function match(regex){
      return function(value){
        return regex.test(value);
      }
    }

    function searchClasses(query){
      return classes.
        filter(match(query)).
        map(function(className){
          return json.classes[className];
      });
    };

    function searchFiles(query){
      return files.
        filter(match(query)).
        map(function(className){
          return json.files[className];
      });
    };

    function searchModules(query){
      return modules.
        filter(match(query)).
        map(function(className){
          return json.modules[className];
      });
    };

    function searchClassItems(query){
      return json.classitems.filter(function(classItem){
        return query.test(classItem.name);
      });
    }

    function splitOnWords(words){
      var splits = words.match(/[A-Z][a-z\#\d]+/g);

      if (splits) {
        return splits.join('.*');
      } else {
        return words;
      }
    }

    function parseQuery(query){
      var matches = query;
      var splitQuery = query.split('#');
      var withMethodsRegex;

      nonMethod = splitQuery.shift();

      if (splitQuery.length === 0){
        methods = nonMethod;
      } else {
        methods = splitQuery.join('|');
      }

      nonMethod = splitOnWords(nonMethod);

      if (nonMethod == ''){
        noMethodsRegex = /^$/;
      } else {
        noMethodsRegex = new RegExp(nonMethod, 'i');
      }

      methodsRegex = new RegExp('(' + methods + ')','i');

      return {
        files: noMethodsRegex,
        modules: noMethodsRegex,
        classes: noMethodsRegex,
        classItems: methodsRegex
      }
    }

    function compileQuery(query){
      return query;
    }

    // view#method
    function search(query){
      result = {};
      if (!query){ return result; }

      query = parseQuery(query);
      result.files = searchFiles(query.files).slice(0,10);
      result.modules = searchModules(query.modules).slice(0,10);
      result.classes = searchClasses(query.classes).slice(0,10);
      result.classItems = searchClassItems(query.classItems).slice(0,30);

      return result;
    }
  </script>

</body>
</html>
